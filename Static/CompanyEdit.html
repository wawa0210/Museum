<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>湖南省博物馆后台管理系统</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="/css/plugins/steps/jquery.steps.css" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>

    <style>
        .wizard > .content > .body { position: relative; }
        .sel_Disable{
        }
    </style>

</head>

<body style="background-color: #fdfeff;">
    <div id="wrapper">
        <div>
           <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>企业信息编辑</small></h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                                <a class="close-link">
                                    <i class="fa fa-times"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <div class="row">
                                <div class="col-sm-8 b-r">
                                    <form class="form-horizontal" id="form_CompanyInfo">
                                        <div class="form-group"><label class="col-sm-3 control-label">公司名称</label>
                                            <div class="col-sm-8"><input type="text" id="ip_companyName" name="companyName" class="form-control" required></div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">行政区划</label>
                                            <div class="col-sm-4">
                                                <select id="sel_County" class="form-control" onchange="CountyChange()">
                                                  <option value="230202" selected="selected">龙沙区</option>
                                                  <option value="230203">建华区</option>
                                                  <option value="230204">铁锋区</option>
                                                  <option value="230205">昂昂溪区</option>
                                                  <option value="230206">富拉尔基区</option>
                                                  <option value="230207">碾子山区</option>
                                                  <option value="230208">梅里斯达斡尔族区</option>
                                                  <option value="230221">龙江县</option>
                                                  <option value="230223">依安县</option>
                                                  <option value="230224">泰来县</option>
                                                  <option value="230225">甘南县</option>
                                                  <option value="230227">富裕县</option>
                                                  <option value="230229">克山县</option>
                                                  <option value="230230">克东县</option>
                                                  <option value="230231">拜泉县</option>
                                                  <option value="230281" >讷河市</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-4"><input type="text" id="ip_adaddressDetail" placeholder="详细地址" name="adaddressDetail"  class="form-control" required></div>
                                        </div>
                                         <div class="form-group"><label class="col-sm-3 control-label">经纬度</label>
                                            <div class="col-sm-4"><input type="text" id="ip_longitude" name="longitude" readonly="readonly" placeholder="请在右侧地图选择定位" class="form-control" required></div>
                                            <div class="col-sm-4"><input type="text" id="ip_latitude" name="latitude" readonly="readonly" placeholder="纬度" class="form-control" requiredee32></div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">邮编</label>
                                            <div class="col-sm-8"><input type="text" id="ip_zipCode" class="form-control"></div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">企业性质</label>
                                            <div class="col-sm-8">
                                                <select class="form-control m-b" id="sel_economy">
                                                  <option value="国有企业">国有企业</option>
                                                  <option value="集体企业">集体企业</option>
                                                  <option value="私营经济">私营经济</option>
                                                  <option value="个体经济">个体经济</option>
                                                  <option value="联营经济">联营经济</option>
                                                  <option value="股份制">股份制</option>
                                                  <option value="外商投资">外商投资</option>
                                                  <option value="港澳台投资">港澳台投资</option>
                                                  <option value="其他">其他</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">安全风险等级</label>
                                            <div class="col-sm-8">
                                                 <select class="form-control m-b" id="sel_RiskLevel">
                                                      <option value="1">1级</option>
                                                      <option value="2">2级</option>
                                                      <option value="3">3级</option>
                                                      <option value="4">4级</option>
                                                    </select>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">企业规模</label>
                                            <div class="col-sm-8">
                                                 <select class="form-control m-b" id="sel_CompanyScale">
                                                      <option value="0-20人">0-20人</option>
                                                      <option value="20-99人">20-99人</option>
                                                      <option value="100-499人">100-499人</option>
                                                      <option value="500-999人">500-999人</option>
                                                      <option value="1000-9999人">1000-9999人</option>
                                                      <option value="10000人以上">10000人以上</option>
                                                    </select>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">成立时间</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_foundedTime">
                                            </div>
                                        </div>
                                         <div class="form-group"><label class="col-sm-3 control-label">发证时间</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_issureTime">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">企业行业</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_industry">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">行业代码</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_industryCode">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">法定代表人</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_owner">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">销售收入</label>
                                            <div class="col-sm-8">
                                                <div class="input-group m-b">
                                                    <input type="text" class="form-control" id="ip_companyIncome">
                                                    <span class="input-group-addon">万元</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">分管安全负责人</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_chiefSafeyName">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">分管安全负责人电话</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_chiefSafeyPhone">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">安全生产管理机构负责人</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_viceSafeyName">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">安全生产管理机构负责人电话</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_viceSafeyPhone">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">安全值班电话</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_onDutyPhone">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">应急咨询电话</label>
                                            <div class="col-sm-8">
                                                <input type="text" class="form-control" id="ip_emergencyPhone">
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-3 control-label">企业详情</label>
                                            <div class="col-sm-8">
                                                <textarea class="form-control" id="ip_companyDetail"> </textarea>
                                            </div>
                                        </div>

                                        <div class="hr-line-dashed"></div>
                                    </form>
                                    <div class="col-sm-4 col-sm-offset-2">
                                        <button class="btn btn-default" id="btn_Cancel" onclick="Cancel()">取消</button>
                                        <button onclick="SaveCompanyInfo()"  class="btn btn-primary" id="btn_Save">保存</button>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <div style="padding-left: 0px;width: 100%;margin-bottom: 10px;">
                                            <input type="text" placeholder="请输入你想搜索的企业或地址" class="form-control" id="ip_search" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-10" style="height:300px;width: 100%;" id="div_loaction">
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <input type="hidden"  id="hid_actionType" value="0" />
    <input type="hidden"  id="hid_companyId" value="0" />
    <input type="hidden"  id="hid_county" />
    <!-- Mainly scripts -->
    <script src="/js/jquery-2.1.1.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="/js/inspinia.js"></script>
    <script src="/js/plugins/pace/pace.min.js"></script>

    <!-- Steps -->
    <script src="/js/plugins/staps/jquery.steps.min.js"></script>

    <!-- Jquery Validate -->
    <script src="/js/plugins/validate/jquery.validate.min.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/plugins/datapicker/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.2&key=682be051dc164d7c0f0a5b008ee726f3&plugin=AMap.Autocomplete"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <!-- Jquery Validate -->
    <script src="/js/plugins/validate/jquery.validate.min.js"></script>

    <script>

        var validator;

        var map = new AMap.Map("div_loaction", {
            zoom: 15,
            center: [123.951848,47.34236]
        });

        AMap.plugin('AMap.Geocoder',function(){
            var geocoder = new AMap.Geocoder({
                city: "230200"//城市齐齐哈尔
            });
            map.on('click',function(e){
                geocoder.getAddress(e.lnglat,function(status,result){
                  if(status=='complete'){
                    $("#sel_County").val(result.regeocode.addressComponent.adcode);
                    $("#ip_adaddressDetail").val(result.regeocode.formattedAddress);
                  }
                })
            })
        });
        var marker = new AMap.Marker({
            map:map,
            bubble:true
        })
        //为地图注册click事件获取鼠标点击出的经纬度坐标
        var clickEventListener = map.on('click', function(e) {
            marker.setPosition(e.lnglat);
            $("#ip_longitude").val(e.lnglat.getLng());
            $("#ip_latitude").val(e.lnglat.getLat());
        });
        var auto = new AMap.Autocomplete({
            input: "ip_search"
        });
        AMap.event.addListener(auto, "select", select);//注册监听，当选中某条记录时会触发

        function select(e) {
            if (e.poi && e.poi.location) {
                marker.setPosition(e.poi.location);
                map.setZoom(15);
                map.setCenter(e.poi.location);
            }
        }


        $(document).ready(function(){
            //判断新增or编辑
            var actionType=getUrlParam("actionType");
            if(actionType=="add"){
                $("#hid_actionType").val("0");
            }
            else{
                var companyId = getUrlParam("companyId");
                if(companyId!=null && companyId!="")
                {
                    LoadCompanyInfo(companyId);
                }
                $("#hid_companyId").val(companyId);
                $("#hid_actionType").val("1");
            }

            $('#ip_foundedTime').datepicker({
                todayBtn: "linked",
                keyboardNavigation: false,
                forceParse: false,
                calendarWeeks: true,
                autoclose: true
            });
            $('#ip_issureTime').datepicker({
                todayBtn: "linked",
                keyboardNavigation: false,
                forceParse: false,
                calendarWeeks: true,
                autoclose: true
            });
       });

        function CountyChange(){
            var county = $("#sel_County").find("option:selected").text();
            $("#hid_county").val(county);
        }

        function Cancel(){
            $("#iframe_DashBoard",parent.document).attr('src',"/Static/CompanyList.html");
        }

        function SaveCompanyInfo(){
            var formInfo = $("#form_CompanyInfo");
            // Disable validation on fields that are disabled or hidden.
            formInfo.validate().settings.ignore = ":disabled,:hidden";
            // Start validation; Prevent going forward if false
            if(!formInfo.valid()){
                validator.focusInvalid();
                return false;
            }

            var companyInfo ={};
                companyInfo.id = $("#hid_companyId").val();
                companyInfo.companyName = $("#ip_companyName").val();
                companyInfo.provice = "黑龙江省"
                companyInfo.provCode = "230000";
                companyInfo.city = "齐齐哈尔市";
                companyInfo.cityCode = "230200";
                companyInfo.county = $("#sel_County").find("option:selected").text();
                companyInfo.countyCode = $("#sel_County").val();
                companyInfo.addressDetail = $("#ip_adaddressDetail").val();
                companyInfo.longitude = $("#ip_longitude").val();
                companyInfo.latitude = $("#ip_latitude").val();
                companyInfo.industry = $("#ip_industry").val();
                companyInfo.economy = $("#sel_economy").val();
                companyInfo.companyDetail = $("#ip_companyDetail").val();
                companyInfo.zipCode = $("#ip_zipCode").val();
                companyInfo.foundedTime = $("#ip_foundedTime").val()==""?null:$("#ip_foundedTime").val()=="";
                companyInfo.issureTime = $("#ip_issureTime").val()==""?null:$("#ip_issureTime").val()=="";
                companyInfo.industryCode = $("#ip_industryCode").val();
                companyInfo.owner = $("#ip_owner").val();
                companyInfo.companyScale = $("#sel_economy").val();
                companyInfo.companyIncome = $("#ip_companyIncome").val()==""?0:$("#ip_companyIncome").val();
                companyInfo.chiefSafeyName = $("#ip_chiefSafeyName").val();
                companyInfo.chiefSafeyPhone = $("#ip_chiefSafeyPhone").val();
                companyInfo.viceSafeyName = $("#ip_viceSafeyName").val();
                companyInfo.viceSafeyPhone = $("#ip_viceSafeyPhone").val();
                companyInfo.onDutyPhone = $("#ip_onDutyPhone").val();
                companyInfo.emergencyPhone = $("#ip_emergencyPhone").val();
                companyInfo.riskLevel = $("#sel_RiskLevel").val();
              
                EditCompanyInfo(companyInfo,function(result){
                   if(result.code=="0"){
                      alert("保存成功");
                      Cancel();
                   }
                   else{
                    alert("保存失败");
                   }
                });
        }

        function EditCompanyInfo(params,callback){
            var uri = '/companies';
            params = JSON.stringify(params);
            if($("#hid_actionType").val()=="0"){
                doPost(uri,params,function(res){
                   if (callback) {
                          callback(res);
                      }
                },"json");
            }
            else{
                //编辑
                doPut(uri,params,function(res){
                   if (callback) {
                          callback(res);
                      }
                },"json");
            }
        }

        //加载公司信息
        function LoadCompanyInfo(companyId){
            GetCompanyInfo(companyId,function(result){
                if(result.code=="0"){
                    var companyInfo = result.data;
                     $("#ip_companyName").val(companyInfo.companyName);
                     $("#sel_County").val(companyInfo.countyCode);
                     $("#ip_adaddressDetail").val(companyInfo.addressDetail);
                     $("#ip_longitude").val(companyInfo.longitude);
                     $("#ip_latitude").val(companyInfo.latitude);
                     $("#ip_industry").val(companyInfo.industry);
                     $("#sel_economy").val(companyInfo.economy);
                     $("#ip_companyDetail").val(companyInfo.companyDetail);
                     $("#ip_zipCode").val(companyInfo.zipCode);
                     $("#ip_foundedTime").val(companyInfo.foundedTime);
                     $("#ip_issureTime").val(companyInfo.issureTime);
                     $("#ip_industryCode").val(companyInfo.industryCode);
                     $("#ip_owner").val(companyInfo.owner);
                     $("#sel_economy").val(companyInfo.companyScale);
                     $("#ip_companyIncome").val(companyInfo.companyIncome);
                     $("#ip_chiefSafeyName").val(companyInfo.chiefSafeyName);
                     $("#ip_chiefSafeyPhone").val(companyInfo.chiefSafeyPhone);
                     $("#ip_viceSafeyName").val(companyInfo.viceSafeyName);
                     $("#ip_viceSafeyPhone").val(companyInfo.viceSafeyPhone);
                     $("#ip_onDutyPhone").val(companyInfo.onDutyPhone);
                     $("#ip_emergencyPhone").val(companyInfo.emergencyPhone);
                     $("#sel_RiskLevel").val(companyInfo.riskLevel);
                }
            });
        }

        function GetCompanyInfo(companyId,callback){
            var uri = '/companies/'+companyId;
            doGet(uri,function(res){
                if (callback) {
                    callback(res);
                }
            });
        }

        function RediectCompanyList(){
            $("#iframe_DashBoard",parent.document).attr('src',"/Static/CompanyList.html");
        }

        $(function(){
             //关闭按钮
            $(".close-link").click(function(){
                RediectCompanyList();
            })

            validator = $("#form_CompanyInfo").validate({  
                rules: {  
                    companyName: { required: true},
                    longitude :{ required: true},
                    latitude :{ required: true},
                    adaddressDetail :{ required: true},
                },  
                messages: {  
                    companyName: {  
                        required: "公司名称不能为空"
                    } ,
                    longitude: {  
                        required: "经度信息不能为空"
                    } ,
                    latitude: {  
                        required: "纬度信息不能为空"
                    },
                    adaddressDetail: {  
                        required: "地址不能为空"
                    } 

                    
                }  
            });  
        })
    </script>

</body>

</html>
